# 慧尖开窗器网关

Home Assistant 自定义集成，用于控制慧尖开窗器网关及设备。

## 功能特性

- ✅ 支持网关在线状态监控
- ✅ 支持网关配对功能
- ✅ 支持开窗器设备控制（开、关、停、A）
- ✅ 支持子设备删除功能
- ✅ 支持电池电压和窗户状态传感器
- ✅ 支持 MQTT 通信协议
- ✅ 支持设备自动发现和添加
- ✅ 支持子设备顺序命名（开窗器 01, 开窗器 02 等）

## 安装方法

### 方法 1：通过 HACS 安装（推荐）
1. 在 HACS 中添加自定义仓库
2. 搜索并安装 "慧尖开窗器网关"
3. 重启 Home Assistant

### 方法 2：手动安装
1. 下载本仓库的 ZIP 文件
2. 解压到 `custom_components` 目录
3. 重启 Home Assistant

## 配置方法

1. 在 Home Assistant 中进入 "配置" > "设备与服务" > "添加集成"
2. 搜索 "慧尖开窗器网关"
3. 输入网关序列号（SN）
4. 点击 "提交" 完成配置

## 设备控制

### 开窗器控制
- **开**：控制开窗器完全打开
- **关**：控制开窗器完全关闭
- **停**：停止开窗器当前动作
- **A**：执行自定义动作（对应 w_travel: 200）

### 网关控制
- **配对**：触发网关进入配对模式，可添加新设备
- **删除按钮**：为每个已配对的开窗器提供单独的删除按钮（格式：开窗器 {SN后四位} 删除），点击后发送解绑命令到网关，移除设备

## 传感器

- **电池电压**：显示开窗器电池电压
- **状态**：显示开窗器当前状态（开/关）

## MQTT 主题

- **发送命令**：`gateway/<sn>/req`
- **接收响应**：`gateway/rpt_rsp`

## 协议类型

- **001**：绑定网关
- **002**：网关状态上报
- **003**：绑定子设备
- **004**：设备控制
- **005**：设备状态上报

## 高级配置

### 缓存配置
- **缓存TTL**：默认缓存时间为60秒，可根据系统负载自动调整
- **缓存大小**：最大缓存设备数为1000个
- **持久化缓存**：设备缓存会持久化到 `device_cache.json` 文件

### 并发控制配置
- **动态并发**：根据系统CPU和内存使用率自动调整并发任务数
- **并发限制**：默认最大并发任务数为10个，最小为1个
- **状态查询限制**：同时最多3个状态查询任务

### MQTT配置
- **重试机制**：实现自适应重试策略，结合抖动和随机化
- **连接检查**：定期检查MQTT连接状态，确保通信稳定
- **命令ID管理**：自动递增命令ID，保持在合理范围内

### 日志配置
- **日志级别**：默认使用INFO级别，可在 `configuration.yaml` 中调整
- **详细调试**：设置日志级别为DEBUG可查看详细的命令发送和设备状态信息

## 故障排除

### 常见错误及解决方案

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|---------|
| `设备不存在，无法发送命令` | 设备未添加到系统中 | 检查设备是否已正确添加，或触发网关配对模式重新添加 |
| `MQTT连接未建立，尝试重连` | MQTT服务异常或网络问题 | 检查MQTT服务状态，确保网络连接正常 |
| `发送MQTT命令失败` | MQTT发布失败或网络问题 | 检查网络连接，确保MQTT服务正常运行 |
| `设备在注册表中未找到` | 设备已被删除或注册表信息丢失 | 重新添加设备或重启Home Assistant |
| `配置条目不存在` | 配置条目已被删除或尚未完全加载 | 重新添加集成或等待系统完全启动 |

### 调试方法

1. **启用详细日志**
   在 `configuration.yaml` 中添加：
   ```yaml
   logger:
     logs:
       custom_components.window_controller_gateway:
         level: debug
   ```

2. **使用MQTT调试面板**
   - 进入Home Assistant的MQTT调试面板
   - 订阅主题：`gateway/rpt_rsp` 查看设备响应
   - 发布消息到：`gateway/<sn>/req` 手动发送命令

3. **检查设备状态**
   - 使用服务 `window_controller_gateway.query_device_status` 查询设备状态
   - 检查设备电池电压，确保电池电量充足

### 性能优化建议

1. **减少并发任务**：在系统负载较高时，系统会自动减少并发任务数
2. **优化缓存使用**：设备信息会被缓存，减少重复查询
3. **批量操作**：设备状态查询采用批量处理，减少MQTT消息数量
4. **自适应查询**：根据设备数量自动调整查询间隔，避免网络拥塞

### 版本兼容性

- **Home Assistant版本**：2021.6 至 2024.5
- **Python版本**：3.9 及以上
- **MQTT集成**：使用Home Assistant内置的MQTT集成

### 迁移指南

1. **从旧版本迁移**
   - 直接更新集成文件
   - 重启Home Assistant
   - 系统会自动保留原有设备配置

2. **网关替换**
   - 确保新网关已正确配置
   - 在Home Assistant中删除旧网关
   - 添加新网关，系统会自动重新发现设备

3. **设备迁移**
   - 设备会自动与新网关关联
   - 原有实体配置会被保留

### 常见陷阱

- **实体残留**：修改 `unique_id` 或 `identifiers` 会导致旧实体残留，需手动删除
- **缓存失效**：系统会自动管理缓存，无需手动清理
- **并发限制**：系统会根据负载自动调整并发数，无需手动配置

## 版本历史

### v1.1.7
- 统一更新版本号为 1.1.7
- 将MQTT重连失败的错误日志改为调试模式，减少添加网关时的日志噪音
- 修改网关配对按键行为，不管是否建立MQTT连接，只要点击就向对应主题发送响应命令
- 优化错误处理，提高系统稳定性

### v1.1.6
- 统一更新版本号为 1.1.6
- 优化异步任务并发控制，根据系统负载动态调整并发数
- 实现自适应设备状态查询间隔和批量查询，提高查询效率
- 优化实体注册表查询，减少数据库查询次数
- 实现 MQTT 消息重试机制的自适应策略，结合抖动和随机化
- 消除魔法数字和字符串，使用常量管理时间相关值
- 优化缓存使用一致性，确保线程安全
- 修复重复的设备查找问题，提高代码效率
- 优化连接池控制，提取公共函数减少代码重复

### v1.1.4
- 统一更新版本号为 1.1.4
- 修复网关重新添加时子设备自动添加功能，确保删除网关后重新添加时能自动关联原有子设备

### v1.1.3
- 统一更新版本号为 1.1.3
- 将集成图标改为使用 MDI 图标，提高兼容性
- 移除本地图片文件路径，避免现代 Home Assistant 版本中的兼容性问题

### v1.1.2
- 统一更新版本号为 1.1.2
- 修复设备移除回调，确保实体被正确删除
- 优化设备重新添加时的回调触发机制

### v1.1.1
- 统一更新版本号为 1.1.1
- 优化代码结构
- 增强系统稳定性

### v1.1.0
- 添加独立的开、关、停按钮实体，确保在任何状态下都可以操作
- 更新版本信息

### v1.0.9
- 优化命令发送逻辑，确保设备存在时才发送命令
- 改进命令ID生成，保持在合理范围内
- 添加详细的命令发送日志，便于调试
- 更新版本信息

### v1.0.8
- 修复关闭按钮灰色不可用问题，确保无论当前状态如何，开、关、停按钮始终可用
- 更新版本信息

### v1.0.7
- 修复按钮灰色不可用问题，确保开、关、停按钮始终可用
- 更新版本信息

### v1.0.6
- 修复删除按钮唯一ID冲突问题
- 改进删除按钮逻辑，当删除设备时同时删除删除按钮自身
- 优化设备删除和重新添加功能

### v1.0.5
- 修复组件重载时重复创建删除按钮导致的唯一ID冲突问题
- 改进删除按钮创建逻辑，确保每个设备只有一个删除按钮

### v1.0.4
- 修改删除按钮命名格式为 "开窗器 {SN后四位} 删除"

### v1.0.3
- 更新版本信息到 1.0.3

### v1.0.2
- 优化删除按钮命名，改为 "开创 {sn后四位} 删除" 格式
- 修复重复创建删除按钮导致的唯一ID冲突问题
- 改进设备控制错误处理，减少错误日志
- 增强网关在线状态检测逻辑
- 优化设备删除和重新添加功能
- 修复版本信息不一致问题

### v1.0.1
- 新增子设备删除功能
- 改进网关在线状态判断逻辑，只要收到任何消息就认为在线
- 修复删除按钮唯一ID冲突问题
- 优化错误处理，提高系统稳定性

### v1.0.0
- 初始版本
- 支持网关在线状态监控
- 支持开窗器设备控制
- 支持电池电压和窗户状态传感器
- 支持 MQTT 通信协议

## 开发者信息

### 核心文件

- `__init__.py` - 集成初始化
- `config_flow.py` - 配置流程
- `const.py` - 常量定义
- `cover.py` - 开窗器控制实体
- `sensor.py` - 传感器实体
- `binary_sensor.py` - 二进制传感器实体
- `button.py` - 按钮实体
- `gateway.py` - 网关实体
- `device_manager.py` - 设备管理器
- `mqtt_handler.py` - MQTT 处理器
- `manifest.json` - 集成信息
- `services.yaml` - 服务定义
- `strings.json` - 字符串定义
- `translations/` - 翻译文件
- `logo.png` - 集成图标

## 贡献指南

欢迎贡献代码、报告问题或提出建议！

1. Fork 本仓库
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 联系方式

- 开发者：慧尖
- 版本：1.1.7
- 适配 Home Assistant 版本：2024.0.0 及以上
